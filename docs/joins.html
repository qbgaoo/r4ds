<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund">
<title>R数据科学 (第二版) - 19&nbsp; 连接</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./import.html" rel="next">
<link href="./missing-values.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script defer="" data-domain="r4ds.hadley.nz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./transform.html">转换</a></li><li class="breadcrumb-item"><a href="./joins.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="展开或折叠侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R数据科学 (第二版)</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/qbgaoo/r4ds-chinese/" title="源代码" class="quarto-navigation-tool px-1" aria-label="源代码"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="切换深色模式"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="切换阅读器模式">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎语</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">序言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">引言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">全貌概览</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据可视化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">工作流程：基础</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据转换</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-style.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">工作流程: 代码风格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-tidy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据整齐</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">工作流程: 脚本和项目</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">数据导入</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-help.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">工作流程：获取帮助</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">可视化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">图层</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./EDA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">探索性数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">交流</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">转换</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logicals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">逻辑向量</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">数值</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">字符串</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regexps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">正则表达式</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">因子</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datetimes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">日期和时间</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing-values.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">缺失值</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./joins.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">导入</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spreadsheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">电子表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./databases.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">数据库</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arrow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Arrow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rectangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">层次数据</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./webscraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">网页抓取</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">编程</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">函数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">迭代</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">R基础实用指南</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./communicate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">交流</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="展开或折叠此栏">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Quarto 格式</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">目 录</h2>
   
  <ul>
<li>
<a href="#%E5%BC%95%E8%A8%80" id="toc-引言" class="nav-link active" data-scroll-target="#%E5%BC%95%E8%A8%80"><span class="header-section-number">19.1</span> 引言</a>
  <ul class="collapse">
<li><a href="#%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6" id="toc-必要条件" class="nav-link" data-scroll-target="#%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6"><span class="header-section-number">19.1.1</span> 必要条件</a></li>
  </ul>
</li>
  <li>
<a href="#%E9%94%AEkeys" id="toc-键keys" class="nav-link" data-scroll-target="#%E9%94%AEkeys"><span class="header-section-number">19.2</span> 键（Keys）</a>
  <ul class="collapse">
<li><a href="#%E4%B8%BB%E9%94%AE%E5%92%8C%E5%A4%96%E9%94%AE" id="toc-主键和外键" class="nav-link" data-scroll-target="#%E4%B8%BB%E9%94%AE%E5%92%8C%E5%A4%96%E9%94%AE"><span class="header-section-number">19.2.1</span> 主键和外键</a></li>
  <li><a href="#%E6%A3%80%E6%9F%A5%E4%B8%BB%E9%94%AE" id="toc-检查主键" class="nav-link" data-scroll-target="#%E6%A3%80%E6%9F%A5%E4%B8%BB%E9%94%AE"><span class="header-section-number">19.2.2</span> 检查主键</a></li>
  <li><a href="#%E4%BB%A3%E7%90%86%E9%94%AE-surrogate-keys" id="toc-代理键-surrogate-keys" class="nav-link" data-scroll-target="#%E4%BB%A3%E7%90%86%E9%94%AE-surrogate-keys"><span class="header-section-number">19.2.3</span> 代理键 (Surrogate keys)</a></li>
  <li><a href="#%E7%BB%83%E4%B9%A0" id="toc-练习" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0"><span class="header-section-number">19.2.4</span> 练习</a></li>
  </ul>
</li>
  <li>
<a href="#sec-mutating-joins" id="toc-sec-mutating-joins" class="nav-link" data-scroll-target="#sec-mutating-joins"><span class="header-section-number">19.3</span> 基本连接</a>
  <ul class="collapse">
<li><a href="#%E5%8F%98%E5%BC%82%E8%BF%9E%E6%8E%A5" id="toc-变异连接" class="nav-link" data-scroll-target="#%E5%8F%98%E5%BC%82%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.3.1</span> 变异连接</a></li>
  <li><a href="#%E6%8C%87%E5%AE%9A%E8%BF%9E%E6%8E%A5%E9%94%AE" id="toc-指定连接键" class="nav-link" data-scroll-target="#%E6%8C%87%E5%AE%9A%E8%BF%9E%E6%8E%A5%E9%94%AE"><span class="header-section-number">19.3.2</span> 指定连接键</a></li>
  <li><a href="#%E7%AD%9B%E9%80%89%E8%BF%9E%E6%8E%A5" id="toc-筛选连接" class="nav-link" data-scroll-target="#%E7%AD%9B%E9%80%89%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.3.3</span> 筛选连接</a></li>
  <li><a href="#%E7%BB%83%E4%B9%A0-1" id="toc-练习-1" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0-1"><span class="header-section-number">19.3.4</span> 练习</a></li>
  </ul>
</li>
  <li>
<a href="#%E8%BF%9E%E6%8E%A5%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84" id="toc-连接是如何工作的" class="nav-link" data-scroll-target="#%E8%BF%9E%E6%8E%A5%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="header-section-number">19.4</span> 连接是如何工作的?</a>
  <ul class="collapse">
<li><a href="#%E8%A1%8C%E5%8C%B9%E9%85%8D" id="toc-行匹配" class="nav-link" data-scroll-target="#%E8%A1%8C%E5%8C%B9%E9%85%8D"><span class="header-section-number">19.4.1</span> 行匹配</a></li>
  <li><a href="#%E7%AD%9B%E9%80%89%E8%BF%9E%E6%8E%A5-1" id="toc-筛选连接-1" class="nav-link" data-scroll-target="#%E7%AD%9B%E9%80%89%E8%BF%9E%E6%8E%A5-1"><span class="header-section-number">19.4.2</span> 筛选连接</a></li>
  </ul>
</li>
  <li>
<a href="#sec-non-equi-joins" id="toc-sec-non-equi-joins" class="nav-link" data-scroll-target="#sec-non-equi-joins"><span class="header-section-number">19.5</span> 非等值连接</a>
  <ul class="collapse">
<li><a href="#%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5" id="toc-交叉连接" class="nav-link" data-scroll-target="#%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.1</span> 交叉连接</a></li>
  <li><a href="#%E4%B8%8D%E7%AD%89%E5%BC%8F%E8%BF%9E%E6%8E%A5" id="toc-不等式连接" class="nav-link" data-scroll-target="#%E4%B8%8D%E7%AD%89%E5%BC%8F%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.2</span> 不等式连接</a></li>
  <li><a href="#%E6%BB%9A%E5%8A%A8%E8%BF%9E%E6%8E%A5" id="toc-滚动连接" class="nav-link" data-scroll-target="#%E6%BB%9A%E5%8A%A8%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.3</span> 滚动连接</a></li>
  <li><a href="#%E9%87%8D%E5%8F%A0%E8%BF%9E%E6%8E%A5" id="toc-重叠连接" class="nav-link" data-scroll-target="#%E9%87%8D%E5%8F%A0%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.4</span> 重叠连接</a></li>
  <li><a href="#%E7%BB%83%E4%B9%A0-2" id="toc-练习-2" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0-2"><span class="header-section-number">19.5.5</span> 练习</a></li>
  </ul>
</li>
  <li><a href="#%E5%B0%8F%E7%BB%93" id="toc-小结" class="nav-link" data-scroll-target="#%E5%B0%8F%E7%BB%93"><span class="header-section-number">19.6</span> 小结</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/qbgaoo/r4ds-chinese/edit/main/joins.qmd" class="toc-action"><i class="bi bi-github"></i>编辑该页面</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./transform.html">转换</a></li><li class="breadcrumb-item"><a href="./joins.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-joins" class="quarto-section-identifier"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="引言" class="level2" data-number="19.1"><h2 data-number="19.1" class="anchored" data-anchor-id="引言">
<span class="header-section-number">19.1</span> 引言</h2>
<p>在数据分析中，很少只涉及单个数据框。通 常你会有多个数据框，并且需要将它们<strong>连接</strong>在一起来回答你感兴趣的问题。本 章将向你介绍两种重要的连接类型：</p>
<ul>
<li>变异连接（Mutating joins），通过匹配另一个数据框中的观测值向一个数据框添加新变量；</li>
<li>筛选连接（Filtering joins），根据一个数据框中的观测值是否与另一个数据框中的观测值匹配来筛选观测值。</li>
</ul>
<p>我们将首先讨论键 (keys)，即用于在连接中连接一对数据框的变量。我 们将通过检查<code>nycflights13</code>包中数据集的键来巩固这一理论，然后利用这些知识开始连接数据框。接 下来我们将讨论连接的工作原理，重点关注它们对行的操作。最 后，我们将讨论非等值连接（non-equi joins），这是一种比默认的等值关系更灵活的键匹配方式连接家族。</p>
<section id="必要条件" class="level3" data-number="19.1.1"><h3 data-number="19.1.1" class="anchored" data-anchor-id="必要条件">
<span class="header-section-number">19.1.1</span> 必要条件</h3>
<p>在本章中，我们将使用来自dplyr的join函数来探索来自<code>nycflights13</code>的五个相关数据集。</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="键keys" class="level2" data-number="19.2"><h2 data-number="19.2" class="anchored" data-anchor-id="键keys">
<span class="header-section-number">19.2</span> 键（Keys）</h2>
<p>要理解连接（join）操作，首先需要理解如何通过每个表中的一对键来连接两个表。在 本节中，你将学习两种类型的键，并在nycflights13包的数据集中看到这两种键的示例。你 还将学习如何检查你的键是否有效，以及如果表中缺少键该如何处理。</p>
<section id="主键和外键" class="level3" data-number="19.2.1"><h3 data-number="19.2.1" class="anchored" data-anchor-id="主键和外键">
<span class="header-section-number">19.2.1</span> 主键和外键</h3>
<p>每次连接操作都涉及一对键：主键 (primary key) 和外键 (foreign key) 。<strong>主</strong> <strong>键</strong>是一个变量或一组变量，用于唯一标识每个观测。当 需要多个变量时，这个键被称为复合键。例 如，在nycflights13包中：</p>
<ul>
<li>
<p><code>airlines</code> 记录关于每家航空公司的两项数据：承运人代码和全名。你 可以使用其两个字母的承运人代码来识别航空公司，使<code>carrier</code> (承运人) 成为主键。</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airlines</span></span>
<span><span class="co">#&gt; # A tibble: 16 × 2</span></span>
<span><span class="co">#&gt;   carrier name                    </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;                   </span></span>
<span><span class="co">#&gt; 1 9E      Endeavor Air Inc.       </span></span>
<span><span class="co">#&gt; 2 AA      American Airlines Inc.  </span></span>
<span><span class="co">#&gt; 3 AS      Alaska Airlines Inc.    </span></span>
<span><span class="co">#&gt; 4 B6      JetBlue Airways         </span></span>
<span><span class="co">#&gt; 5 DL      Delta Air Lines Inc.    </span></span>
<span><span class="co">#&gt; 6 EV      ExpressJet Airlines Inc.</span></span>
<span><span class="co">#&gt; # ℹ 10 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>airports</code> 记录了关于每个机场的数据。你 可以通过其三个字母的机场代码来识别每个机场，使<code>faa</code>成为主键。</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span></span>
<span><span class="co">#&gt; # A tibble: 1,458 × 8</span></span>
<span><span class="co">#&gt;   faa   name                            lat   lon   alt    tz dst  </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;                         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 04G   Lansdowne Airport              41.1 -80.6  1044    -5 A    </span></span>
<span><span class="co">#&gt; 2 06A   Moton Field Municipal Airport  32.5 -85.7   264    -6 A    </span></span>
<span><span class="co">#&gt; 3 06C   Schaumburg Regional            42.0 -88.1   801    -6 A    </span></span>
<span><span class="co">#&gt; 4 06N   Randall Airport                41.4 -74.4   523    -5 A    </span></span>
<span><span class="co">#&gt; 5 09J   Jekyll Island Airport          31.1 -81.4    11    -5 A    </span></span>
<span><span class="co">#&gt; 6 0A9   Elizabethton Municipal Airpo…  36.4 -82.2  1593    -5 A    </span></span>
<span><span class="co">#&gt; # ℹ 1,452 more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: tzone &lt;chr&gt;</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>planes</code> 记录关于每架飞机的数据。你 可以通过其尾号来识别一架飞机，使<code>tailnum</code>成为主键。</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">planes</span></span>
<span><span class="co">#&gt; # A tibble: 3,322 × 9</span></span>
<span><span class="co">#&gt;   tailnum  year type              manufacturer    model     engines</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;           &lt;chr&gt;       &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 N10156   2004 Fixed wing multi… EMBRAER         EMB-145XR       2</span></span>
<span><span class="co">#&gt; 2 N102UW   1998 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; 3 N103US   1999 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; 4 N104UW   1999 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; 5 N10575   2002 Fixed wing multi… EMBRAER         EMB-145LR       2</span></span>
<span><span class="co">#&gt; 6 N105UW   1999 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; # ℹ 3,316 more rows</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>weather</code> 记录关于出发机场的天气数据。你 可以通过位置和时间的组合来识别每个观测，使<code>origin</code>和<code>time_hour</code>成为复合主键。</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span></span>
<span><span class="co">#&gt; # A tibble: 26,115 × 15</span></span>
<span><span class="co">#&gt;   origin  year month   day  hour  temp  dewp humid wind_dir</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 EWR     2013     1     1     1  39.0  26.1  59.4      270</span></span>
<span><span class="co">#&gt; 2 EWR     2013     1     1     2  39.0  27.0  61.6      250</span></span>
<span><span class="co">#&gt; 3 EWR     2013     1     1     3  39.0  28.0  64.4      240</span></span>
<span><span class="co">#&gt; 4 EWR     2013     1     1     4  39.9  28.0  62.2      250</span></span>
<span><span class="co">#&gt; 5 EWR     2013     1     1     5  39.0  28.0  64.4      260</span></span>
<span><span class="co">#&gt; 6 EWR     2013     1     1     6  37.9  28.0  67.2      240</span></span>
<span><span class="co">#&gt; # ℹ 26,109 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: wind_speed &lt;dbl&gt;, wind_gust &lt;dbl&gt;, …</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<p>外键是一个变量（或变量集），它对应于另一个表中的主键。例 如：</p>
<ul>
<li>
<code>flights$tailnum</code> 是一个外键，它对应于主键 <code>planes$tailnum</code>.</li>
<li>
<code>flights$carrier</code> 是一个外键，它对应于主键 <code>airlines$carrier</code>.</li>
<li>
<code>flights$origin</code> 是一个外键，它对应于主键 <code>airports$faa</code>.</li>
<li>
<code>flights$dest</code> 是一个外键，它对应于主键 <code>airports$faa</code>.</li>
<li>
<code>flights$origin</code>-<code>flights$time_hour</code> 是一个复合外键，它对应于复合主键 <code>weather$origin</code>-<code>weather$time_hour</code>.</li>
</ul>
<p>这些关系在 <a href="#fig-flights-relationships" class="quarto-xref">图&nbsp;<span>19.1</span></a> 中以图形方式进行了总结。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-flights-relationships" class="quarto-figure quarto-figure-center quarto-float anchored" alt="The relationships between airports, planes, flights, weather, and airlines datasets from the nycflights13 package. airports$faa connected to the flights$origin and flights$dest. planes$tailnum is connected to the flights$tailnum. weather$time_hour and weather$origin are jointly connected to flights$time_hour and flights$origin. airlines$carrier is connected to flights$carrier. There are no direct connections between airports, planes, airlines, and weather data frames.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-flights-relationships-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/relational.png" class="img-fluid figure-img" alt="The relationships between airports, planes, flights, weather, and airlines datasets from the nycflights13 package. airports$faa connected to the flights$origin and flights$dest. planes$tailnum is connected to the flights$tailnum. weather$time_hour and weather$origin are jointly connected to flights$time_hour and flights$origin. airlines$carrier is connected to flights$carrier. There are no direct connections between airports, planes, airlines, and weather data frames." width="502">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flights-relationships-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.1: Connections between all five data frames in the nycflights13 package. Variables making up a primary key are colored grey, and are connected to their corresponding foreign keys with arrows.
</figcaption></figure>
</div>
</div>
</div>
<p>你会注意到这些键的设计中的一个很好的特征：主键和外键几乎总是具有相同的名称，正如你很快就会看到的，这将使你的连接操作变得更加容易。同 样值得注意的是相反的关系：在多个表中使用的几乎每个变量名在每个位置都有相同的含义。只 有一个例外：在<code>flights</code>表中<code>year</code>表示出发年份，而在<code>planes</code>表中，<code>year</code>表示制造年份。当 我们开始实际将表连接在一起时，这一点将变得很重要。</p>
</section><section id="检查主键" class="level3" data-number="19.2.2"><h3 data-number="19.2.2" class="anchored" data-anchor-id="检查主键">
<span class="header-section-number">19.2.2</span> 检查主键</h3>
<p>既然我们已经确定了每个表的主键，那么验证它们确实能唯一地标识每个观测是明智的做法。一 种方法是<code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code>主键的数量，并查找<code>n</code>大于 1 的条目。结 果表明<code>planes</code>和<code>weather</code>两个表都没有问题：</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">planes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 2</span></span>
<span><span class="co">#&gt; # ℹ 2 variables: tailnum &lt;chr&gt;, n &lt;int&gt;</span></span>
<span></span>
<span><span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">time_hour</span>, <span class="va">origin</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 3</span></span>
<span><span class="co">#&gt; # ℹ 3 variables: time_hour &lt;dttm&gt;, origin &lt;chr&gt;, n &lt;int&gt;</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>你也应该检查主键中是否有缺失值：如果某个值缺失了，那么它就无法标识一个观测！</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">planes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 9</span></span>
<span><span class="co">#&gt; # ℹ 9 variables: tailnum &lt;chr&gt;, year &lt;int&gt;, type &lt;chr&gt;, manufacturer &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;</span></span>
<span></span>
<span><span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">time_hour</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 15</span></span>
<span><span class="co">#&gt; # ℹ 15 variables: origin &lt;chr&gt;, year &lt;int&gt;, month &lt;int&gt;, day &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   hour &lt;int&gt;, temp &lt;dbl&gt;, dewp &lt;dbl&gt;, humid &lt;dbl&gt;, wind_dir &lt;dbl&gt;, …</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="代理键-surrogate-keys" class="level3" data-number="19.2.3"><h3 data-number="19.2.3" class="anchored" data-anchor-id="代理键-surrogate-keys">
<span class="header-section-number">19.2.3</span> 代理键 (Surrogate keys)</h3>
<p>到目前为止，我们还没有谈到<code>flights</code>的主键。在 这里它不是特别重要，因为没有数据框使用它作为外键；但考虑它仍然是有用的，因为如果我们有某种方式可以向其他人描述观测，那么处理这些观测会更加容易。</p>
<p>经过一些思考和尝试，我们确定有三个变量一起能够唯一地标识每次航班：</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">time_hour</span>, <span class="va">carrier</span>, <span class="va">flight</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 4</span></span>
<span><span class="co">#&gt; # ℹ 4 variables: time_hour &lt;dttm&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, n &lt;int&gt;</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>缺少重复项是否自动使<code>time_hour</code>-<code>carrier</code>-<code>flight</code>成为主键？当 然这是一个好的开始，但并不能保证成功。例 如，海拔和纬度是否适合作为<code>airports</code>的主键？</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">alt</span>, <span class="va">lat</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;     alt   lat     n</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    13  40.6     2</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>仅通过海拔和纬度来识别机场显然是一个糟糕的主意，而且通常仅凭数据本身是无法知道变量组合是否可以成为一个好的主键的。但 是对于航班来说，<code>time_hour</code>、<code>carrier</code>和<code>flight</code>的组合看起来是合理的，因为如果同时有多个航班在空中使用相同的航班号，对于航空公司和其客户来说会非常混乱的。</p>
<p>不过，我们最好使用行号来引入一个简单的数字代理键：</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">flights2</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 20</span></span>
<span><span class="co">#&gt;      id  year month   day dep_time sched_dep_time dep_delay arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1     1  2013     1     1      517            515         2      830</span></span>
<span><span class="co">#&gt; 2     2  2013     1     1      533            529         4      850</span></span>
<span><span class="co">#&gt; 3     3  2013     1     1      542            540         2      923</span></span>
<span><span class="co">#&gt; 4     4  2013     1     1      544            545        -1     1004</span></span>
<span><span class="co">#&gt; 5     5  2013     1     1      554            600        -6      812</span></span>
<span><span class="co">#&gt; 6     6  2013     1     1      554            558        -4      740</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, …</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>代理键在与他人交流时特别有用：告诉某人查看航班2001比告诉某人查看2013年1月3日上午9点起飞的UA430航班要容易得多。</p>
</section><section id="练习" class="level3" data-number="19.2.4"><h3 data-number="19.2.4" class="anchored" data-anchor-id="练习">
<span class="header-section-number">19.2.4</span> 练习</h3>
<ol type="1">
<li><p>在 <a href="#fig-flights-relationships" class="quarto-xref">图&nbsp;<span>19.1</span></a> 中，我们忘记了画出<code>weather</code> 和<code>airports</code>之间的关系。这 种关系是什么？它 应该如何出现在图中？</p></li>
<li><p><code>weather</code> 数据只包含纽约市三个出发机场的信息。如 果它包含了美国所有机场的天气记录，那么它会与<code>flights</code>产生什么样的额外关联？</p></li>
<li><p><code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, 和 <code>origin</code> 几乎构成了天气的复合键，但是有一个小时有重复的观察记录。你 能找出那个小时有什么特别之处吗？</p></li>
<li><p>我们知道一年中的某些天是特殊的，通常会比平时少人乘坐飞机（例如，平安夜和圣诞节）。你 如何将这些数据表示为数据框？主 键会是什么？它 将如何与现有的数据框连接？</p></li>
<li><p>画一个图，说明Lahman包中<code>Batting</code>、<code>People</code>和<code>Salaries</code>数据框之间的连接关系。再 画一个图，显示<code>People</code>、<code>Managers</code>和<code>AwardsManagers</code>之间的关系。你 会如何描述<code>Batting</code>、<code>Pitching</code>和<code>Fielding</code>数据框之间的关系？</p></li>
</ol></section></section><section id="sec-mutating-joins" class="level2" data-number="19.3"><h2 data-number="19.3" class="anchored" data-anchor-id="sec-mutating-joins">
<span class="header-section-number">19.3</span> 基本连接</h2>
<p>既然你已经理解了如何通过键来连接数据框，现在就可以开始使用连接来更好地理解<code>flights</code>数据集了。d plyr提供了六种连接函数：<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join()</a></code>和<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join()</a></code>。这 些函数都具有相同的接口：它们接受一对数据框（<code>x</code>和<code>y</code>）并返回一个数据框。输 出中行和列的顺序主要由<code>x</code>决定。</p>
<p>在本节中，你将学习如何使用一个变异连接<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>和两个筛选连接<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join()</a></code>和<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join()</a></code>。在 下一节中，你将详细了解这些函数是如何工作的，包括剩下的<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code>和<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code>。</p>
<section id="变异连接" class="level3" data-number="19.3.1"><h3 data-number="19.3.1" class="anchored" data-anchor-id="变异连接">
<span class="header-section-number">19.3.1</span> 变异连接</h3>
<p><strong>变异连接</strong>允许你将两个数据框中的变量组合起来：它首先通过键来匹配观测值，然后将一个数据框中的变量复制到另一个数据框中。与 <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>函数类似，连接函数将变量添加到右侧，因此如果你的数据集有很多变量，你可能不会立即看到新添加的变量。为 了这些示例，我们将通过创建一个仅包含六个变量的较窄数据集来更容易地查看发生了什么<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>：</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">time_hour</span>, <span class="va">origin</span>, <span class="va">dest</span>, <span class="va">tailnum</span>, <span class="va">carrier</span><span class="op">)</span></span>
<span><span class="va">flights2</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 6</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA     </span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA     </span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA     </span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6     </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL     </span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA     </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>变异连接有四种类型，但有一种你几乎总是会用到：<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>。它 很特别，因为输出总是与<code>x</code>（你正在连接的数据框）有相同的行<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>的主要用途是添加额外的元数据。 例如，我们可以使用<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>向<code>flights2</code>数据中添加完整的航空公司名称：</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airlines</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(carrier)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 7</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier name                </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      United Air Lines In…</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      United Air Lines In…</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      American Airlines I…</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      JetBlue Airways     </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      Delta Air Lines Inc.</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      United Air Lines In…</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者我们可以查找每架飞机起飞时的温度和风速：</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">weather</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">time_hour</span>, <span class="va">temp</span>, <span class="va">wind_speed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(time_hour, origin)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 8</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier  temp wind_speed</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA       39.0       12.7</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA       39.9       15.0</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA       39.0       15.0</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6       39.0       15.0</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL       39.9       16.1</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA       39.0       12.7</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者查看当时飞行的是哪种大小的飞机：</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tailnum</span>, <span class="va">type</span>, <span class="va">engines</span>, <span class="va">seats</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(tailnum)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 9</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier type                </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 2 more variables: engines &lt;int&gt;, seats &lt;int&gt;</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>当<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>找不到与<code>x</code>中某行相匹配的记录时，它会用缺失值来填充新的变量。例 如，没有关于尾号为<code>N3ALAA</code>的飞机的信息，因此其<code>type</code>、<code>engines</code>和<code>seats</code>将是缺失的：</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tailnum</span> <span class="op">==</span> <span class="st">"N3ALAA"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tailnum</span>, <span class="va">type</span>, <span class="va">engines</span>, <span class="va">seats</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(tailnum)`</span></span>
<span><span class="co">#&gt; # A tibble: 63 × 9</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier type  engines seats</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 06:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-02 18:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-03 06:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-07 19:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-08 17:00:00 JFK    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-16 06:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; # ℹ 57 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在本章剩下的部分，我们还会多次回到这个问题。</p>
</section><section id="指定连接键" class="level3" data-number="19.3.2"><h3 data-number="19.3.2" class="anchored" data-anchor-id="指定连接键">
<span class="header-section-number">19.3.2</span> 指定连接键</h3>
<p>默认情况下，<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>会使用两个数据框中都出现的所有变量作为连接键，这被称为自然连接 (<strong>natural</strong> join)。这 是一个有用的启发式方法，但并不总是有效。例 如，如果我们尝试将<code>flights2</code>与完整的<code>planes</code>数据集连接，会发生什么呢？</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(year, tailnum)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 13</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier type  manufacturer</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;       </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 5 more variables: model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;, …</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们得到了很多缺失的匹配项，因为连接试图使用<code>tailnum</code>和<code>year</code>作为复合键。<code>f</code> <code>lights</code>和<code>planes</code>都有一个<code>year</code>列，但它们表示的是不同的含义：<code>flights$year</code>是航班发生的年份，而<code>planes$year</code>是飞机制造的年份。我 们只想通过<code>tailnum</code>进行连接，因此我们需要使用<code><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by()</a></code>来提供一个明确的规范。</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 14</span></span>
<span><span class="co">#&gt;   year.x time_hour           origin dest  tailnum carrier year.y</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1   2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA        1999</span></span>
<span><span class="co">#&gt; 2   2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA        1998</span></span>
<span><span class="co">#&gt; 3   2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA        1990</span></span>
<span><span class="co">#&gt; 4   2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6        2012</span></span>
<span><span class="co">#&gt; 5   2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL        1991</span></span>
<span><span class="co">#&gt; 6   2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA        2012</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: type &lt;chr&gt;, manufacturer &lt;chr&gt;, model &lt;chr&gt;, …</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>请注意，在输出中<code>year</code>变量通过后缀（<code>year.x</code> 和 <code>year.y</code>）来区分，以告诉你该变量来自<code>x</code>还是<code>y</code>参数。你 可以使用<code>suffix</code>参数来覆盖默认后缀。</p>
<p><code>join_by(tailnum)</code>是<code>join_by(tailnum == tailnum)</code>的简写。了 解这种完整形式很重要，原因有两个：首先，它描述了两个表之间的关系：键必须相等。这 就是为什么这种连接类型通常被称为等值连接 (<strong>equi join</strong>)。你 将在@sec-non-equi-joins 学习非等值连接。</p>
<p>其次，这是你在每个表中指定不同连接键的方式。例 如，有两种方式可以将<code>flight2</code>和<code>airports</code>表连接起来：通过<code>dest</code>或<code>origin</code>。</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 13</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier name                </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      George Bush Interco…</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      George Bush Interco…</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      Miami Intl          </span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      &lt;NA&gt;                </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      Hartsfield Jackson …</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      Chicago Ohare Intl  </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: lat &lt;dbl&gt;, lon &lt;dbl&gt;, alt &lt;dbl&gt;, tz &lt;dbl&gt;, …</span></span>
<span></span>
<span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">origin</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 13</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier name               </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;              </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      Newark Liberty Intl</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      La Guardia         </span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      John F Kennedy Intl</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      John F Kennedy Intl</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      La Guardia         </span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      Newark Liberty Intl</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: lat &lt;dbl&gt;, lon &lt;dbl&gt;, alt &lt;dbl&gt;, tz &lt;dbl&gt;, …</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在旧代码中，你可能会看到使用字符向量来指定连接键的不同方式：</p>
<ul>
<li>
<code>by = "x"</code>对应于<code>join_by(x)</code>。</li>
<li>
<code>by = c("a" = "x")</code>对应于<code>join_by(a == x)</code>。</li>
</ul>
<p>既然现在有了<code><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by()</a></code>，我们更倾向于使用它，因为它提供了更清晰且更灵活的规范。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code>与<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>的接口相同。它 们之间的区别在于保留哪些行：左连接保留<code>x</code>中的所有行，右连接保留<code>y</code>中的所有行，全连接保留<code>x</code>或<code>y</code>中的所有行，而内连接仅保留在<code>x</code>和<code>y</code>中都出现的行。我 们将在稍后更详细地讨论这些连接类型。</p>
</section><section id="筛选连接" class="level3" data-number="19.3.3"><h3 data-number="19.3.3" class="anchored" data-anchor-id="筛选连接">
<span class="header-section-number">19.3.3</span> 筛选连接</h3>
<p>正如你可能猜到的，筛选连接的主要操作是筛选行。有 两种类型：半连接（semi-join）和反连接（anti-join）。半 连接保留<code>x</code>在<code>y</code>中有匹配项的所有行。例 如，我们可以使用半连接来筛选机场数据集，仅显示始发机场：</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights2</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">faa</span> <span class="op">==</span> <span class="va">origin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 8</span></span>
<span><span class="co">#&gt;   faa   name                  lat   lon   alt    tz dst   tzone           </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;           </span></span>
<span><span class="co">#&gt; 1 EWR   Newark Liberty Intl  40.7 -74.2    18    -5 A     America/New_York</span></span>
<span><span class="co">#&gt; 2 JFK   John F Kennedy Intl  40.6 -73.8    13    -5 A     America/New_York</span></span>
<span><span class="co">#&gt; 3 LGA   La Guardia           40.8 -73.9    22    -5 A     America/New_York</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者仅仅是目的地:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights2</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">faa</span> <span class="op">==</span> <span class="va">dest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 101 × 8</span></span>
<span><span class="co">#&gt;   faa   name                     lat    lon   alt    tz dst   tzone          </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;                  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;          </span></span>
<span><span class="co">#&gt; 1 ABQ   Albuquerque Internati…  35.0 -107.   5355    -7 A     America/Denver </span></span>
<span><span class="co">#&gt; 2 ACK   Nantucket Mem           41.3  -70.1    48    -5 A     America/New_Yo…</span></span>
<span><span class="co">#&gt; 3 ALB   Albany Intl             42.7  -73.8   285    -5 A     America/New_Yo…</span></span>
<span><span class="co">#&gt; 4 ANC   Ted Stevens Anchorage…  61.2 -150.    152    -9 A     America/Anchor…</span></span>
<span><span class="co">#&gt; 5 ATL   Hartsfield Jackson At…  33.6  -84.4  1026    -5 A     America/New_Yo…</span></span>
<span><span class="co">#&gt; 6 AUS   Austin Bergstrom Intl   30.2  -97.7   542    -6 A     America/Chicago</span></span>
<span><span class="co">#&gt; # ℹ 95 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>反连接则相反：它们返回x在y中没有匹配项的所有行。它 们在寻找数据中隐式的缺失值方面很有用，这是 <a href="missing-values.html#sec-missing-implicit" class="quarto-xref"><span>小节 18.3</span></a> 的主题。隐 式的缺失值不会显示为<code>NA</code>，而仅表现为缺失。例 如，我们可以通过查找没有匹配目的地机场的航班来找到<code>airports</code>数据集中缺失的行：</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 1</span></span>
<span><span class="co">#&gt;   dest </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 BQN  </span></span>
<span><span class="co">#&gt; 2 SJU  </span></span>
<span><span class="co">#&gt; 3 STT  </span></span>
<span><span class="co">#&gt; 4 PSE</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者我们可以找出哪些<code>tailnum</code>在<code>planes</code>数据集中缺失：</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">planes</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 722 × 1</span></span>
<span><span class="co">#&gt;   tailnum</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 N3ALAA </span></span>
<span><span class="co">#&gt; 2 N3DUAA </span></span>
<span><span class="co">#&gt; 3 N542MQ </span></span>
<span><span class="co">#&gt; 4 N730MQ </span></span>
<span><span class="co">#&gt; 5 N9EAMQ </span></span>
<span><span class="co">#&gt; 6 N532UA </span></span>
<span><span class="co">#&gt; # ℹ 716 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="练习-1" class="level3" data-number="19.3.4"><h3 data-number="19.3.4" class="anchored" data-anchor-id="练习-1">
<span class="header-section-number">19.3.4</span> 练习</h3>
<ol type="1">
<li><p>找出全年中延误最严重的48小时，并与<code>weather</code>数据进行交叉比对。你 能否看到任何模式？</p></li>
<li>
<p>假设你使用这段代码找到了最受欢迎的10个目的地:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">top_dest</span> <span class="op">&lt;-</span> <span class="va">flights2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">dest</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>你怎样才能找到去这些目的地的所有航班呢?</p>
</li>
<li><p>是否每个起飞的航班都有对应的该小时天气数据？</p></li>
<li><p>那些在<code>planes</code>中没有匹配记录的尾号有什么共同之处？( 提示: 一个变量解释了约90%的问题）</p></li>
<li><p>给<code>planes</code>数据框添加一个列，列出飞过该飞机的所有航空公司。你 可能会期望飞机和航空公司之间存在一种隐式关系，因为每架飞机都由单一的航空公司运营。使 用你在前几章中学到的工具来证实或反驳这一假设。</p></li>
<li><p>将起飞机场和目的地机场的纬度和经度添加到<code>flights</code>数据框中。在 连接之前还是之后重命名列更容易？</p></li>
<li>
<p>按目的地计算平均延误时间，然后与<code>airports</code>数据框进行连接，以便你可以展示延误的空间分布。以 下是一个绘制美国地图的简单方法：</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">faa</span> <span class="op">==</span> <span class="va">dest</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/borders.html">borders</a></span><span class="op">(</span><span class="st">"state"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>你可能想使用点的大小或颜色来显示每个机场的平均延误时间。</p>
</li>
<li><p>2013年6月13日发生了什么？画 一张延误地图，然后使用Google与天气进行交叉比对。</p></li>
</ol></section></section><section id="连接是如何工作的" class="level2" data-number="19.4"><h2 data-number="19.4" class="anchored" data-anchor-id="连接是如何工作的">
<span class="header-section-number">19.4</span> 连接是如何工作的?</h2>
<p>既然你已经使用连接操作几次了，现在是时候深入了解它们是如何工作的了，重点关注<code>x</code>中的每一行如何与<code>y</code>中的行进行匹配。我 们将从引入连接的视觉表示开始，使用下面定义的简单tibble，并在 <a href="#fig-join-setup" class="quarto-xref">图&nbsp;<span>19.2</span></a> 中展示。在 这些例子中，我们将使用名为<code>key</code>的单个键和一个值列（<code>val_x</code>和val_y），但这些想法都可以推广到多个键和多个值。</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"x1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x2"</span>,</span>
<span>     <span class="fl">3</span>, <span class="st">"x3"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"y1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"y2"</span>,</span>
<span>     <span class="fl">4</span>, <span class="st">"y3"</span></span>
<span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-setup" class="quarto-figure quarto-figure-center quarto-float anchored" alt="x and y are two data frames with 2 columns and 3 rows, with contents as described in the text. The values of the keys are colored: 1 is green, 2 is purple, 3 is orange, and 4 is yellow.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-setup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/setup.png" class="img-fluid figure-img" alt="x and y are two data frames with 2 columns and 3 rows, with contents as described in the text. The values of the keys are colored: 1 is green, 2 is purple, 3 is orange, and 4 is yellow." width="160">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-setup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.2: Graphical representation of two simple tables. The colored <code>key</code> columns map background color to key value. The grey columns represent the “value” columns that are carried along for the ride.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-join-setup2" class="quarto-xref">图&nbsp;<span>19.3</span></a> 为我们的视觉表示法奠定了基础。它 展示了<code>x</code>和<code>y</code>之间所有可能的匹配，这些匹配是从<code>x</code>的每一行和<code>y</code>的每一行绘制出的线条的交点。输 出结果中的行和列主要由<code>x</code>决定，因此<code>x</code>表格是水平的，并且与输出结果对齐。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-setup2" class="quarto-figure quarto-figure-center quarto-float anchored" alt="x and y are placed at right-angles, with horizonal lines extending from x and vertical lines extending from y. There are 3 rows in x and 3 rows in y, which leads to nine intersections representing nine potential matches.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-setup2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/setup2.png" class="img-fluid figure-img" alt="x and y are placed at right-angles, with horizonal lines extending from x and vertical lines extending from y. There are 3 rows in x and 3 rows in y, which leads to nine intersections representing nine potential matches." width="170">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-setup2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.3: To understand how joins work, it’s useful to think of every possible match. Here we show that with a grid of connecting lines.
</figcaption></figure>
</div>
</div>
</div>
<p>为了描述一种特定的连接类型，我们用点来表示匹配项，这些匹配项决定了输出的行。输 出是一个新的数据框，包含键、x值和y值。例 如，<a href="#fig-join-inner" class="quarto-xref">图&nbsp;<span>19.4</span></a> 展示了内连接，只有当键相等时，行才会被保留。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-inner" class="quarto-figure quarto-figure-center quarto-float anchored" alt="x and y are placed at right-angles with lines forming a grid of potential matches. Keys 1 and 2 appear in both x and y, so we get a match, indicated by a dot. Each dot corresponds to a row in the output, so the resulting joined data frame has two rows.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-inner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/inner.png" class="img-fluid figure-img" alt="x and y are placed at right-angles with lines forming a grid of potential matches. Keys 1 and 2 appear in both x and y, so we get a match, indicated by a dot. Each dot corresponds to a row in the output, so the resulting joined data frame has two rows." width="363">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-inner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.4: An inner join matches each row in <code>x</code> to the row in <code>y</code> that has the same value of <code>key</code>. Each match becomes a row in the output.
</figcaption></figure>
</div>
</div>
</div>
<p>我们可以应用同样的原理来解释外连接 (<strong>outer joins</strong>)，外连接会保留至少在一个数据框中出现的观测值。这 些连接通过在每个数据框中添加一个额外的“虚拟”观测值来实现。这 个观测值具有一个键，当没有其他键匹配时，它会匹配，并将值填充为<code>NA</code>。有 三种类型的外连接：</p>
<ul>
<li>
<p>左连接保留<code>x</code>中的所有观测值，如 <a href="#fig-join-left" class="quarto-xref">图&nbsp;<span>19.5</span></a> 所示。<code>x</code> 的每一行都保留在输出中，因为它可以退回到与<code>y</code>中的<code>NA</code>行进行匹配。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-left" class="quarto-figure quarto-figure-center quarto-float anchored" alt="Compared to the previous diagram showing an inner join, the y table gets a new virtual row containin NA that will match any row in x that didn't otherwise match. This means that the output now has three rows. For key = 3, which matches this virtual row, val_y takes value NA.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-left-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/left.png" class="img-fluid figure-img" alt="Compared to the previous diagram showing an inner join, the y table gets a new virtual row containin NA that will match any row in x that didn't otherwise match. This means that the output now has three rows. For key = 3, which matches this virtual row, val_y takes value NA." width="385">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-left-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.5: A visual representation of the left join where every row in <code>x</code> appears in the output.
</figcaption></figure>
</div>
</div>
</div>
</li>
<li>
<p>右连接保留<code>y</code>中的所有观测值，如图 <a href="#fig-join-right" class="quarto-xref">图&nbsp;<span>19.6</span></a> 所示。<code>y</code> 的每一行都保留在输出中，因为它可以退回到与<code>x</code>中的<code>NA</code>行进行匹配。输 出仍然尽可能与<code>x</code>进行匹配；<code>y</code>中的任何额外行都会添加到末尾。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-right" class="quarto-figure quarto-figure-center quarto-float anchored" alt="Compared to the previous diagram showing an left join, the x table now gains a virtual row so that every row in y gets a match in x. val_x contains NA for the row in y that didn't match x.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-right-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/right.png" class="img-fluid figure-img" alt="Compared to the previous diagram showing an left join, the x table now gains a virtual row so that every row in y gets a match in x. val_x contains NA for the row in y that didn't match x." width="380">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-right-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.6: A visual representation of the right join where every row of <code>y</code> appears in the output.
</figcaption></figure>
</div>
</div>
</div>
</li>
<li>
<p>全连接保留出现在<code>x</code>或<code>y</code>中的所有观测值，如图 <a href="#fig-join-full" class="quarto-xref">图&nbsp;<span>19.7</span></a> 所示。<code>x</code> 和<code>y</code>的每一行都包含在输出中，因为<code>x</code>和<code>y</code>都有一个回退行为<code>NA</code>。同 样，输出以<code>x</code>的所有行开始，然后是剩余的未匹配的<code>y</code>行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-full" class="quarto-figure quarto-figure-center quarto-float anchored" alt="Now both x and y have a virtual row that always matches. The result has 4 rows: keys 1, 2, 3, and 4 with all values from val_x and val_y, however key 2, val_y and key 4, val_x are NAs since those keys don't have a match in the other data frames.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/full.png" class="img-fluid figure-img" alt="Now both x and y have a virtual row that always matches. The result has 4 rows: keys 1, 2, 3, and 4 with all values from val_x and val_y, however key 2, val_y and key 4, val_x are NAs since those keys don't have a match in the other data frames." width="388">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.7: A visual representation of the full join where every row in <code>x</code> and <code>y</code> appears in the output.
</figcaption></figure>
</div>
</div>
</div>
</li>
</ul>
<p>另一种展示不同类型的外连接差异的方法是使用文氏图 (Venn diagram)，如 <a href="#fig-join-venn" class="quarto-xref">图&nbsp;<span>19.8</span></a> 所示。然 而，这并不是一个很好的表示方法，因为它虽然可能会唤起你对哪些行被保留的记忆，但它无法说明列发生了什么。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-venn" class="quarto-figure quarto-figure-center quarto-float anchored" alt="Venn diagrams for inner, full, left, and right joins. Each join represented with two intersecting circles representing data frames x and y, with x on the right and y on the left. Shading indicates the result of the join.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-venn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/venn.png" class="img-fluid figure-img" alt="Venn diagrams for inner, full, left, and right joins. Each join represented with two intersecting circles representing data frames x and y, with x on the right and y on the left. Shading indicates the result of the join." width="385">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-venn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.8: Venn diagrams showing the difference between inner, left, right, and full joins.
</figcaption></figure>
</div>
</div>
</div>
<p>这里展示的连接被称为等值连接，即当键相等时行会匹配。等 值连接是最常见的连接类型，因此我们通常会省略equi前缀，只说“内连接”而不是“等值内连接”。我 们将在@sec-non-equi-joins 讨论非等值连接。</p>
<section id="行匹配" class="level3" data-number="19.4.1"><h3 data-number="19.4.1" class="anchored" data-anchor-id="行匹配">
<span class="header-section-number">19.4.1</span> 行匹配</h3>
<p>到目前为止，我们已经探讨了<code>x</code>中的一行与<code>y</code>中的零行或一行匹配时会发生什么。但 如果它匹配多行时会发生什么呢？为 了理解这一点，让我们首先关注<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>函数，然后画一张图，如 <a href="#fig-join-match-types" class="quarto-xref">图&nbsp;<span>19.9</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-match-types" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A join diagram where x has key values 1, 2, and 3, and y has key values 1, 2, 2. The output has three rows because key 1 matches one row, key 2 matches two rows, and key 3 matches zero rows.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-match-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/match-types.png" class="img-fluid figure-img" alt="A join diagram where x has key values 1, 2, and 3, and y has key values 1, 2, 2. The output has three rows because key 1 matches one row, key 2 matches two rows, and key 3 matches zero rows." width="348">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-match-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.9: The three ways a row in <code>x</code> can match. <code>x1</code> matches one row in <code>y</code>, <code>x2</code> matches two rows in <code>y</code>, <code>x3</code> matches zero rows in y. Note that while there are three rows in <code>x</code> and three rows in the output, there isn’t a direct correspondence between the rows.
</figcaption></figure>
</div>
</div>
</div>
<p><code>x</code>中的行有三种可能的结果：</p>
<ul>
<li>如果它不匹配任何行，它将被删除；</li>
<li>如果它与<code>y</code>中的一行匹配，它将被保留；</li>
<li>如果它与<code>y</code>中的多行匹配，它将为每个匹配项复制一次。</li>
</ul>
<p>原则上，这意味着输出中的行与<code>x</code>中的行之间没有保证的对应关系，但在实践中，这种情况很少会引起问题。然 而，有一种特别危险的情况可能导致行的组合爆炸，想象一下连接以下两个表：</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, val_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, val_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y1"</span>, <span class="st">"y2"</span>, <span class="st">"y3"</span><span class="op">)</span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>虽然<code>df1</code>的第一行只与<code>df2</code>中的一行匹配，但第二行和第三行都与两行匹配。这 个有时被称为多对多 (<code>many-to-many</code>) 连接，将会导致dplyr发出警告：</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">df2</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in inner_join(df1, df2, join_by(key)): Detected an unexpected many-to-many relationship between `x` and `y`.</span></span>
<span><span class="co">#&gt; ℹ Row 2 of `x` matches multiple rows in `y`.</span></span>
<span><span class="co">#&gt; ℹ Row 2 of `y` matches multiple rows in `x`.</span></span>
<span><span class="co">#&gt; ℹ If a many-to-many relationship is expected, set `relationship =</span></span>
<span><span class="co">#&gt;   "many-to-many"` to silence this warning.</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2   </span></span>
<span><span class="co">#&gt; 3     2 x2    y3   </span></span>
<span><span class="co">#&gt; 4     2 x3    y2   </span></span>
<span><span class="co">#&gt; 5     2 x3    y3</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果你有意这么做，可以按照警告的提示设置 <code>relationship = "many-to-many"</code>。</p>
</section><section id="筛选连接-1" class="level3" data-number="19.4.2"><h3 data-number="19.4.2" class="anchored" data-anchor-id="筛选连接-1">
<span class="header-section-number">19.4.2</span> 筛选连接</h3>
<p>匹配的数量也决定了筛选连接的行为。半 连接保留<code>x</code>在<code>y</code>中有一个或多个匹配的行，如 <a href="#fig-join-semi" class="quarto-xref">图&nbsp;<span>19.10</span></a> 所示。反 连接保留<code>x</code>在<code>y</code>中零个匹配的行，如 <a href="#fig-join-anti" class="quarto-xref">图&nbsp;<span>19.11</span></a> 所示。在 这两种情况下，仅匹配的存在是重要的，匹配的次数并不重要。这 意味着筛选连接永远不会像变异连接那样重复行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-semi" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A join diagram with old friends x and y. In a semi join, only the presence of a match matters so the output contains the same columns as x.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-semi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/semi.png" class="img-fluid figure-img" alt="A join diagram with old friends x and y. In a semi join, only the presence of a match matters so the output contains the same columns as x." width="318">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-semi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.10: In a semi-join it only matters that there is a match; otherwise values in <code>y</code> don’t affect the output.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-anti" class="quarto-figure quarto-figure-center quarto-float anchored" alt="An anti-join is the inverse of a semi-join so matches are drawn with red lines indicating that they will be dropped from the output.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-anti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/anti.png" class="img-fluid figure-img" alt="An anti-join is the inverse of a semi-join so matches are drawn with red lines indicating that they will be dropped from the output." width="317">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-anti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.11: An anti-join is the inverse of a semi-join, dropping rows from <code>x</code> that have a match in <code>y</code>.
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-non-equi-joins" class="level2" data-number="19.5"><h2 data-number="19.5" class="anchored" data-anchor-id="sec-non-equi-joins">
<span class="header-section-number">19.5</span> 非等值连接</h2>
<p>到目前为止，你只看到了等连接（equi joins），也就是当<code>x</code>的键等于<code>y</code>的键时行才会匹配。现 在我们放宽这个限制，并讨论确定一对行是否匹配的其他方法。</p>
<p>但是，在我们这样做之前，我们需要回顾一下上面所做的简化。在 等连接中，<code>x</code>的键和<code>y</code>的键总是相等的，所以我们只需要在输出中显示一个。我 们可以要求dplyr通过<code>keep = TRUE</code>保留两个键，这将导致下面的代码和 <a href="#fig-inner-both" class="quarto-xref">图&nbsp;<span>19.12</span></a> 中重新绘制的<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>。</p>
<p>So far you’ve only seen equi joins, joins where the rows match if the <code>x</code> key equals the <code>y</code> key. Now we’re going to relax that restriction and discuss other ways of determining if a pair of rows match.</p>
<p>But before we can do that, we need to revisit a simplification we made above. In equi joins the <code>x</code> keys and <code>y</code> are always equal, so we only need to show one in the output. We can request that dplyr keep both keys with <code>keep = TRUE</code>, leading to the code below and the re-drawn <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code> in <a href="#fig-inner-both" class="quarto-xref">图&nbsp;<span>19.12</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="va">key</span><span class="op">)</span>, keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   key.x val_x key.y val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1        1 y1   </span></span>
<span><span class="co">#&gt; 2     2 x2        2 y2</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-inner-both" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A join diagram showing an inner join betwen x and y. The result now includes four columns: key.x, val_x, key.y, and val_y. The values of key.x and key.y are identical, which is why we usually only show one. ">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-inner-both-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/inner-both.png" class="img-fluid figure-img" alt="A join diagram showing an inner join betwen x and y. The result now includes four columns: key.x, val_x, key.y, and val_y. The values of key.x and key.y are identical, which is why we usually only show one. " width="415">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inner-both-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.12: An inner join showing both <code>x</code> and <code>y</code> keys in the output.
</figcaption></figure>
</div>
</div>
</div>
<p>当我们从等值连接转向非等值连接时，我们总是会显示键，因为键值通常会有所不同。例 如，我们不再仅在<code>x$key</code>和<code>y$key</code>相等时才进行匹配，而是可以在<code>x$key</code>大于或等于<code>y$key</code>时进行匹配，如 <a href="#fig-join-gte" class="quarto-xref">图&nbsp;<span>19.13</span></a> 所示。d plyr的连接函数理解等值连接和非等值连接之间的区别，因此当你执行非等值连接时，它总是会显示两个键。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-gte" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A join diagram illustrating join_by(key >= key). The first row of x matches one row of y and the second and thirds rows each match two rows. This means the output has five rows containing each of the following (key.x, key.y) pairs: (1, 1), (2, 1), (2, 2), (3, 1), (3, 2).">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-gte-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/gte.png" class="img-fluid figure-img" alt="A join diagram illustrating join_by(key >= key). The first row of x matches one row of y and the second and thirds rows each match two rows. This means the output has five rows containing each of the following (key.x, key.y) pairs: (1, 1), (2, 1), (2, 2), (3, 1), (3, 2)." width="385">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-gte-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.13: A non-equi join where the <code>x</code> key must be greater than or equal to the <code>y</code> key. Many rows generate multiple matches.
</figcaption></figure>
</div>
</div>
</div>
<p>“非等值连接”这个术语不是特别有用，因为它只告诉你这个连接不是什么，而不是它是什么。d plyr通过识别四种特别有用的非等值连接类型来帮助你：</p>
<ul>
<li>
<strong>交叉连接 (cross joins)</strong> 匹配每一对行；</li>
<li>
<strong>不等式(inequality joins)</strong> 使用 <code>&lt;</code>、<code>&lt;=</code>、<code>&gt;</code> 和 <code>&gt;=</code> 而不是 <code>==</code>；</li>
<li>
<strong>滚动连接 (rolling joins)</strong> 类似于不等式连接，但只找到最接近的匹配项；</li>
<li>
<strong>重叠连接 (overlap joins)</strong> 是一种特殊的不等式连接类型，专为处理范围而设计。</li>
</ul>
<p>这些类型将在以下部分中更详细地描述。</p>
<section id="交叉连接" class="level3" data-number="19.5.1"><h3 data-number="19.5.1" class="anchored" data-anchor-id="交叉连接">
<span class="header-section-number">19.5.1</span> 交叉连接</h3>
<p>交叉连接会匹配所有内容，如 <a href="#fig-join-cross" class="quarto-xref">图&nbsp;<span>19.14</span></a> 所示，生成行的笛卡尔积。这 意味着输出将具有<code>nrow(x) * nrow(y)</code>行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-cross" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A join diagram showing a dot for every combination of x and y.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-cross-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/cross.png" class="img-fluid figure-img" alt="A join diagram showing a dot for every combination of x and y." width="155">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-cross-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.14: A cross join matches each row in <code>x</code> with every row in <code>y</code>.
</figcaption></figure>
</div>
</div>
</div>
<p>交叉连接在生成排列时很有用。例 如下面的代码生成了所有可能的名称对。因 为我们正在将<code>df</code>与其自身连接，所以这有时被称为自连接 (<strong>self-join</strong>)。交 叉连接使用不同的连接函数，因为在匹配每一行时，没有内连接/左连接/右连接/全连接之间的区别。</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"John"</span>, <span class="st">"Simon"</span>, <span class="st">"Tracy"</span>, <span class="st">"Max"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/cross_join.html">cross_join</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 16 × 2</span></span>
<span><span class="co">#&gt;   name.x name.y</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1 John   John  </span></span>
<span><span class="co">#&gt; 2 John   Simon </span></span>
<span><span class="co">#&gt; 3 John   Tracy </span></span>
<span><span class="co">#&gt; 4 John   Max   </span></span>
<span><span class="co">#&gt; 5 Simon  John  </span></span>
<span><span class="co">#&gt; 6 Simon  Simon </span></span>
<span><span class="co">#&gt; # ℹ 10 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="不等式连接" class="level3" data-number="19.5.2"><h3 data-number="19.5.2" class="anchored" data-anchor-id="不等式连接">
<span class="header-section-number">19.5.2</span> 不等式连接</h3>
<p>不等连接使用 <code>&lt;</code>、<code>&lt;=</code>、<code>&gt;</code> 或 <code>&gt;=</code> 来限制可能匹配的集合，如 <a href="#fig-join-gte" class="quarto-xref">图&nbsp;<span>19.13</span></a> 和 <a href="#fig-join-lt" class="quarto-xref">图&nbsp;<span>19.15</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-lt" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A diagram depicting an inequality join where a data frame x is joined by a data frame y where the key of x is less than the key of y, resulting in a triangular shape in the top-left corner.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-lt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/lt.png" class="img-fluid figure-img" alt="A diagram depicting an inequality join where a data frame x is joined by a data frame y where the key of x is less than the key of y, resulting in a triangular shape in the top-left corner." width="185">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-lt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.15: An inequality join where <code>x</code> is joined to <code>y</code> on rows where the key of <code>x</code> is less than the key of <code>y</code>. This makes a triangular shape in the top-left corner.
</figcaption></figure>
</div>
</div>
</div>
<p>不等连接非常通用，以至于很难提出有意义的特定用例。一 个有用的小技巧是使用它们来限制交叉连接，以便我们不是生成所有排列，而是生成所有组合：</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"John"</span>, <span class="st">"Simon"</span>, <span class="st">"Tracy"</span>, <span class="st">"Max"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">id</span> <span class="op">&lt;</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 4</span></span>
<span><span class="co">#&gt;    id.x name.x  id.y name.y</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;  &lt;int&gt; &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1     1 John       2 Simon </span></span>
<span><span class="co">#&gt; 2     1 John       3 Tracy </span></span>
<span><span class="co">#&gt; 3     1 John       4 Max   </span></span>
<span><span class="co">#&gt; 4     2 Simon      3 Tracy </span></span>
<span><span class="co">#&gt; 5     2 Simon      4 Max   </span></span>
<span><span class="co">#&gt; 6     3 Tracy      4 Max</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="滚动连接" class="level3" data-number="19.5.3"><h3 data-number="19.5.3" class="anchored" data-anchor-id="滚动连接">
<span class="header-section-number">19.5.3</span> 滚动连接</h3>
<p>滚动连接是一种特殊的不等式连接，其中不是获取满足不等式的每一行，而是仅获取最接近的行，如 <a href="#fig-join-closest" class="quarto-xref">图&nbsp;<span>19.16</span></a> 所示。你 可以通过将<code>closest()</code>添加到不等连接中来将其转换为滚动连接。例 如<code>join_by(closest(x &lt;= y))</code>将匹配大于或等于<code>x</code>的最小的<code>y</code>，而<code>join_by(closest(x &gt; y))</code>将匹配小于<code>x</code>的最大的<code>y</code>。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-closest" class="quarto-figure quarto-figure-center quarto-float anchored" alt="A rolling join is a subset of an inequality join so some matches are grayed out indicating that they're not used because they're not the &quot;closest&quot;.">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-closest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/closest.png" class="img-fluid figure-img" alt="A rolling join is a subset of an inequality join so some matches are grayed out indicating that they're not used because they're not the &quot;closest&quot;." width="262">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-closest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;19.16: A rolling join is similar to a greater-than-or-equal inequality join but only matches the first value.
</figcaption></figure>
</div>
</div>
</div>
<p>滚动连接在以下场景特别有用：假如你有两个日期表，但日期并不完全对应；你想要在表1中找到与表2中某个日期最接近的日期 (之前或之后)。</p>
<p>例如，假设你负责你们办公室的派对策划委员会。由 于公司比较节俭，不是举办单独的派对，而是每个季度只举办一次。确 定派对日期的规则有些复杂：派对总是在星期一举行，而且你跳过了1月的第一周，因为很多人都在休假。此 外，2022年第三季度的第一个星期一是7月4日，所以派对必须推迟一周。基 于这些规则，以下是确定的派对日期：</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  party <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在，假设你有一张员工生日的表格：</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">employees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu">babynames</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/babynames/man/babynames.html">babynames</a></span><span class="op">$</span><span class="va">name</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  birthday <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">365</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">employees</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 2</span></span>
<span><span class="co">#&gt;   name     birthday  </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Kemba    2022-01-22</span></span>
<span><span class="co">#&gt; 2 Orean    2022-06-26</span></span>
<span><span class="co">#&gt; 3 Kirstyn  2022-02-11</span></span>
<span><span class="co">#&gt; 4 Amparo   2022-11-11</span></span>
<span><span class="co">#&gt; 5 Belen    2022-03-25</span></span>
<span><span class="co">#&gt; 6 Rayshaun 2022-01-11</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>对于每个员工，我们都想找到在他们生日之后（或当天）的第一个派对日期。我 们可以用滚动连接来表示这一点：</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">employees</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu">closest</span><span class="op">(</span><span class="va">birthday</span> <span class="op">&gt;=</span> <span class="va">party</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 4</span></span>
<span><span class="co">#&gt;   name     birthday       q party     </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;date&gt;     &lt;int&gt; &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Kemba    2022-01-22     1 2022-01-10</span></span>
<span><span class="co">#&gt; 2 Orean    2022-06-26     2 2022-04-04</span></span>
<span><span class="co">#&gt; 3 Kirstyn  2022-02-11     1 2022-01-10</span></span>
<span><span class="co">#&gt; 4 Amparo   2022-11-11     4 2022-10-03</span></span>
<span><span class="co">#&gt; 5 Belen    2022-03-25     1 2022-01-10</span></span>
<span><span class="co">#&gt; 6 Rayshaun 2022-01-11     1 2022-01-10</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然而，这种方法存在一个问题：在1月10日之前过生日的人没有派对：</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">employees</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu">closest</span><span class="op">(</span><span class="va">birthday</span> <span class="op">&gt;=</span> <span class="va">party</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   name   birthday  </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Maks   2022-01-07</span></span>
<span><span class="co">#&gt; 2 Nalani 2022-01-04</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>为了解决这个问题，我们需要以不同的方式处理它，即使用重叠连接。</p>
</section><section id="重叠连接" class="level3" data-number="19.5.4"><h3 data-number="19.5.4" class="anchored" data-anchor-id="重叠连接">
<span class="header-section-number">19.5.4</span> 重叠连接</h3>
<p>重叠连接提供了三个辅助函数，这些函数使用不等式连接来简化区间操作：</p>
<ul>
<li>
<code>between(x, y_lower, y_upper)</code> 是 <code>x &gt;= y_lower, x &lt;= y_upper</code>的简写；</li>
<li>
<code>within(x_lower, x_upper, y_lower, y_upper)</code> 是 <code>x_lower &gt;= y_lower, x_upper &lt;= y_upper</code>的简写；</li>
<li>
<code>overlaps(x_lower, x_upper, y_lower, y_upper)</code> 是 <code>x_lower &lt;= y_upper, x_upper &gt;= y_lower</code>的简写。</li>
</ul>
<p>让我们继续生日的例子，看看如何使用这些函数。我 们之前使用的策略有一个问题：1月1日到9日之间过生日的人没有派对。因 此，明确每个派对涵盖的日期范围，并为这些早过生日的人设置一个特殊情况可能会更好：</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  party <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  start <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-01"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  end <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-04-03"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-02"</span>, <span class="st">"2022-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">parties</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span><span class="co">#&gt;       q party      start      end       </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 2     2 2022-04-04 2022-04-04 2022-07-11</span></span>
<span><span class="co">#&gt; 3     3 2022-07-11 2022-07-11 2022-10-02</span></span>
<span><span class="co">#&gt; 4     4 2022-10-03 2022-10-03 2022-12-31</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hadley 在数据录入方面糟糕透顶，因此他还想检查派对时间段是否重叠。一 种方法是通过自连接来检查是否有任何开始-结束区间与其他区间重叠：</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu">overlaps</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, <span class="va">q</span> <span class="op">&lt;</span> <span class="va">q</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">start.x</span>, <span class="va">end.x</span>, <span class="va">start.y</span>, <span class="va">end.y</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 4</span></span>
<span><span class="co">#&gt;   start.x    end.x      start.y    end.y     </span></span>
<span><span class="co">#&gt;   &lt;date&gt;     &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 2022-04-04 2022-07-11 2022-07-11 2022-10-02</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>哎呀，有重叠的区间，让我们修复这个问题并继续：</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  party <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  start <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-01"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  end <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-04-03"</span>, <span class="st">"2022-07-10"</span>, <span class="st">"2022-10-02"</span>, <span class="st">"2022-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在我们可以将每个员工与他们的派对匹配起来。这 里非常适合使用<code>unmatched = "error"</code>选项，因为我们想快速找出是否有员工没有被分配到派对。</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">employees</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">birthday</span>, <span class="va">start</span>, <span class="va">end</span><span class="op">)</span><span class="op">)</span>, unmatched <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 6</span></span>
<span><span class="co">#&gt;   name     birthday       q party      start      end       </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;date&gt;     &lt;int&gt; &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Kemba    2022-01-22     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 2 Orean    2022-06-26     2 2022-04-04 2022-04-04 2022-07-10</span></span>
<span><span class="co">#&gt; 3 Kirstyn  2022-02-11     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 4 Amparo   2022-11-11     4 2022-10-03 2022-10-03 2022-12-31</span></span>
<span><span class="co">#&gt; 5 Belen    2022-03-25     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 6 Rayshaun 2022-01-11     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="练习-2" class="level3" data-number="19.5.5"><h3 data-number="19.5.5" class="anchored" data-anchor-id="练习-2">
<span class="header-section-number">19.5.5</span> 练习</h3>
<ol type="1">
<li>
<p>你能解释下面等值连接的键是如何工作的吗？它 们的结果为什么是不同的？</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="va">key</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2   </span></span>
<span><span class="co">#&gt; 3     3 x3    &lt;NA&gt; </span></span>
<span><span class="co">#&gt; 4     4 &lt;NA&gt;  y3</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="va">key</span><span class="op">)</span>, keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span><span class="co">#&gt;   key.x val_x key.y val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1        1 y1   </span></span>
<span><span class="co">#&gt; 2     2 x2        2 y2   </span></span>
<span><span class="co">#&gt; 3     3 x3       NA &lt;NA&gt; </span></span>
<span><span class="co">#&gt; 4    NA &lt;NA&gt;      4 y3</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li><p>在检查任何派对时间段是否与另一个派对时间段重叠时，我们在<code><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by()</a></code>中使用了<code>q &lt; q</code>。为 什么？如 果去掉这个不等式会发生什么?</p></li>
</ol></section></section><section id="小结" class="level2" data-number="19.6"><h2 data-number="19.6" class="anchored" data-anchor-id="小结">
<span class="header-section-number">19.6</span> 小结</h2>
<p>在本章中，你学习了如何使用变异连接和过滤连接来合并来自两个数据框的数据。在 此过程中，你学习了如何识别键，以及主键和外键之间的区别。你 还了解了连接的工作原理，以及如何计算输出将有多少行。最 后，初步了解了非等值连接的强大功能，并看到了一些有趣的应用案例。</p>
<p>本章结束了本书“转换”部分的内容，该部分重点关注了你可以使用单个列和tibble的工具。你 学习了dplyr和基础函数来处理逻辑向量、数字和完整表格，学习了stringr函数来处理字符串，lubridate函数来处理日期和时间，以及forcats函数来处理因子。</p>
<p>在本书的下一部分，你将学习更多关于如何将各种类型的数据以整齐的形式导入到R中。</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>记住，在RStudio中，你也可以使用<code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>来避免这个问题。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>这并不是百分百正确，但如果不是，你就会得到警告。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/qbgaoo\.github\.io\/r4ds\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./missing-values.html" class="pagination-link" aria-label="缺失值">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">缺失值</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./import.html" class="pagination-link" aria-label="导入">
        <span class="nav-page-text">导入</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>此书英文版由 Hadley Wickham 等人编写</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/qbgaoo/r4ds-chinese/edit/main/joins.qmd" class="toc-action"><i class="bi bi-github"></i>编辑该页面</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>这是中文版, 由 Qing-Bin Gao 翻译</p>
</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>